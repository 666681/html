<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰¾ç‘Ÿå…°å¤§é™†å†’é™©</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(to bottom, #1a1a2e, #16213e);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .game-header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .game-title {
            color: var(--light);
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px var(--secondary);
        }
        
        .game-subtitle {
            color: var(--light);
            font-size: 1.2rem;
            opacity: 0.8;
        }
        
        .game-area {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .player-panel {
            flex: 1;
            min-width: 300px;
            background: rgba(30, 40, 60, 0.8);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            color: var(--light);
        }
        
        .game-content {
            flex: 3;
            min-width: 300px;
            background: rgba(20, 30, 40, 0.8);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            color: var(--light);
        }
        
        .panel-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--secondary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 5px;
        }
        
        .player-info {
            margin-bottom: 20px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: rgba(40, 60, 90, 0.7);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-name {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
        }
        
        .skill-list {
            margin-top: 20px;
        }
        
        .skill {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin-bottom: 8px;
            background: rgba(40, 60, 90, 0.5);
            border-radius: 5px;
        }
        
        .game-console {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-family: monospace;
            border: 1px solid #444;
        }
        
        .console-message {
            padding: 5px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 15px;
            border: none;
            border-radius: 5px;
            background: var(--secondary);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-attack { background: var(--danger); }
        .btn-skill { background: var(--warning); }
        .btn-item { background: var(--success); }
        .btn-flee { background: #9b59b6; }
        .btn-action { background: #1abc9c; }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(40, 60, 90, 0.7);
            padding: 10px;
            border-radius: 5px;
        }
        
        .day-info, .location-info, .alignment-info {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .value {
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #555;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: var(--secondary);
            border-radius: 10px;
            transition: width 0.5s;
        }
        
        .hp-bar .progress { background: var(--danger); }
        .mp-bar .progress { background: var(--secondary); }
        .xp-bar .progress { background: var(--success); }
        
        .character-info {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .character-name {
            font-size: 1.8rem;
            color: var(--secondary);
            margin-bottom: 10px;
        }
        
        .character-status {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .element-icon {
            display: inline-block;
            font-size: 1.5rem;
            margin: 0 3px;
        }
        
        .battle-enemies {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }
        
        .enemy-card {
            background: rgba(100, 30, 30, 0.7);
            padding: 15px;
            border-radius: 10px;
            min-width: 150px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .enemy-card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.5);
        }
        
        .enemy-name {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #ff8a8a;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        select, input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            width: 100%;
        }
        
        .weather-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(50, 50, 80, 0.6);
            border-radius: 5px;
        }
        
        .weather-icon {
            font-size: 2rem;
        }
        
        .battle-log {
            padding: 10px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 5px;
            font-size: 1.1rem;
        }
        
        .battle-log div {
            padding: 5px;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        }
        
        .choice-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        .choice-btn {
            padding: 15px;
            background: rgba(52, 152, 219, 0.4);
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .choice-btn:hover {
            background: rgba(52, 152, 219, 0.8);
            transform: scale(1.03);
        }
        
        .element-fire { color: #e74c3c; }
        .element-ice { color: #3498db; }
        .element-lightning { color: #f1c40f; }
        
        .battle-damage {
            color: #ff8a8a;
            font-weight: bold;
        }
        
        .battle-heal {
            color: #7bed9f;
            font-weight: bold;
        }
        
        .battle-critical {
            color: #f1c40f;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .choice-options {
                grid-template-columns: 1fr;
            }
            
            .input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-header">
            <h1 class="game-title">è‰¾ç‘Ÿå…°å¤§é™†å†’é™©</h1>
            <p class="game-subtitle">ä¸€åœºå…ƒç´ ä¸é“å¾·çš„å¥‡å¹»æ—…ç¨‹</p>
        </div>
        
        <div class="status-bar">
            <div class="day-info">
                <span>å¤©æ•°</span>
                <span id="day-value" class="value">1</span>
            </div>
            <div class="location-info">
                <span>ä½ç½®</span>
                <span id="location-value" class="value">èµ·å§‹ä¹‹æ‘</span>
            </div>
            <div class="alignment-info">
                <span>é˜µè¥</span>
                <span id="alignment-value" class="value">ç»å¯¹ä¸­ç«‹</span>
            </div>
        </div>
        
        <div class="game-area">
            <div class="player-panel">
                <h2 class="panel-title">ç©å®¶ä¿¡æ¯</h2>
                
                <div class="character-info">
                    <div class="character-name" id="character-name">è‹±é›„</div>
                    <div class="character-status" id="character-status">Lv.1 [100/100 HP | 50/50 MP | å…ƒç´ : ğŸ”¥]</div>
                </div>
                
                <div class="progress-bar hp-bar">
                    <div id="hp-progress" class="progress" style="width: 100%"></div>
                </div>
                
                <div class="progress-bar mp-bar">
                    <div id="mp-progress" class="progress" style="width: 100%"></div>
                </div>
                
                <div class="progress-bar xp-bar">
                    <div id="xp-progress" class="progress" style="width: 0%"></div>
                </div>
                
                <div class="weather-info">
                    <div class="weather-icon" id="weather-icon">â˜€ï¸</div>
                    <div>
                        <div id="weather-type">æ™´å¤©</div>
                        <div id="weather-effect">ç«å±æ€§å¢å¼º</div>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-name">åŠ›é‡</div>
                        <div id="stat-strength" class="stat-value">15</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-name">æ•æ·</div>
                        <div id="stat-agility" class="stat-value">10</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-name">æ™ºåŠ›</div>
                        <div id="stat-intelligence" class="stat-value">8</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-name">ç­‰çº§</div>
                        <div id="stat-level" class="stat-value">1</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-name">ç»éªŒ</div>
                        <div id="stat-xp" class="stat-value">0</div>
                    </div>
                </div>
                
                <div class="skill-list">
                    <div class="panel-title">æŠ€èƒ½</div>
                    <div class="skill">
                        <div>ğŸ”¥ ç«çƒæœ¯</div>
                        <div>10 MP</div>
                    </div>
                    <div class="skill">
                        <div>ğŸ’« æ²»ç–—æœ¯</div>
                        <div>15 MP</div>
                    </div>
                </div>
            </div>
            
            <div class="game-content">
                <h2 class="panel-title" id="content-title">æ¸¸æˆæ—¥å¿—</h2>
                
                <div id="game-console" class="game-console">
                    <div class="console-message">æ¬¢è¿æ¥åˆ°è‰¾ç‘Ÿå…°å¤§é™†ï¼</div>
                    <div class="console-message">è¯·è¾“å…¥ä½ çš„è§’è‰²åå¼€å§‹å†’é™©...</div>
                </div>
                
                <div id="action-container">
                    <div id="name-input-section" style="display: block;">
                        <div class="input-group">
                            <input type="text" id="character-name-input" placeholder="è¾“å…¥è§’è‰²å">
                            <button id="start-btn" class="btn btn-action">å¼€å§‹å†’é™©</button>
                        </div>
                    </div>
                    
                    <div id="battle-section" style="display: none;">
                        <div id="battle-enemies" class="battle-enemies">
                            <!-- æ•Œäººä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-attack" data-action="attack">æ”»å‡»</button>
                            <button class="btn btn-skill" data-action="skill">æŠ€èƒ½</button>
                            <button class="btn btn-item" data-action="item">ç‰©å“</button>
                            <button class="btn btn-flee" data-action="flee">é€ƒè·‘</button>
                        </div>
                    </div>
                    
                    <div id="skill-select-section" style="display: none;">
                        <div class="input-group">
                            <select id="skill-select">
                                <option value="fireball">ğŸ”¥ ç«çƒæœ¯ (10 MP)</option>
                                <option value="heal">ğŸ’« æ²»ç–—æœ¯ (15 MP)</option>
                            </select>
                            <button id="use-skill-btn" class="btn btn-skill">ä½¿ç”¨æŠ€èƒ½</button>
                        </div>
                    </div>
                    
                    <div id="event-section" style="display: none;">
                        <div id="event-description" class="battle-log">
                            <!-- äº‹ä»¶æè¿°ä¼šåœ¨è¿™é‡Œ -->
                        </div>
                        <div id="event-options" class="choice-options">
                            <!-- é€‰é¡¹ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ•°æ®ä¸çŠ¶æ€
        const gameState = {
            player: null,
            day: 1,
            location: "èµ·å§‹ä¹‹æ‘",
            alignment: 0,
            battleActive: false,
            enemies: [],
            weather: "sunny",
            currentEvent: null,
            gameStarted: false
        };

        // è§’è‰²ç±»
        class Character {
            constructor(name) {
                this.name = name;
                this.hp = 100;
                this.maxHp = 100;
                this.mp = 50;
                this.maxMp = 50;
                this.strength = 15;
                this.agility = 10;
                this.intelligence = 8;
                this.elementAffinity = "fire";
                this.level = 1;
                this.experience = 0;
                this.skills = [
                    { id: "fireball", name: "ç«çƒæœ¯", cost: 10, power: 30, element: "fire" },
                    { id: "heal", name: "æ²»ç–—æœ¯", cost: 15, power: 0, element: null }
                ];
            }
            
            getCharacterStatus() {
                return `Lv.${this.level} [${this.hp}/${this.maxHp} HP | ${this.mp}/${this.maxMp} MP | å…ƒç´ : ${this.getElementIcon()}]`;
            }
            
            getElementIcon() {
                switch(this.elementAffinity) {
                    case "fire": return "ğŸ”¥";
                    case "ice": return "â„ï¸";
                    case "lightning": return "âš¡";
                    default: return "";
                }
            }
            
            takeDamage(damage) {
                this.hp = Math.max(0, this.hp - damage);
                return this.hp > 0;
            }
            
            heal(amount) {
                this.hp = Math.min(this.maxHp, this.hp + amount);
            }
            
            addExperience(amount) {
                this.experience += amount;
                const neededExp = this.level * 100;
                if (this.experience >= neededExp) {
                    this.levelUp();
                    return true;
                }
                return false;
            }
            
            levelUp() {
                while (this.experience >= this.level * 100) {
                    this.level++;
                    this.experience -= (this.level - 1) * 100;
                    
                    // æå‡å±æ€§
                    const hpIncrease = Math.floor(Math.random() * 8) + 8;
                    const mpIncrease = Math.floor(Math.random() * 6) + 5;
                    
                    this.maxHp += hpIncrease;
                    this.hp = this.maxHp;
                    this.maxMp += mpIncrease;
                    this.mp = this.maxMp;
                    
                    this.strength += Math.floor(Math.random() * 3) + 1;
                    this.agility += Math.floor(Math.random() * 2) + 1;
                    this.intelligence += Math.floor(Math.random() * 3) + 1;
                    
                    addToConsole(`â­ ${this.name} å‡çº§äº†ï¼ç°åœ¨æ˜¯ç­‰çº§ ${this.level}ï¼`);
                    addToConsole(`æœ€å¤§ç”Ÿå‘½å€¼ +${hpIncrease} | æœ€å¤§é­”æ³•å€¼ +${mpIncrease}`);
                }
            }
        }

        // æ•Œäººç±»
        class Enemy {
            constructor(type) {
                this.type = type;
                switch(type) {
                    case "goblin":
                        this.name = "å“¥å¸ƒæ—";
                        this.hp = this.maxHp = 40;
                        this.atk = 8;
                        this.weakness = "ice";
                        this.rewardExp = 15;
                        break;
                    case "wolf":
                        this.name = "é‡ç‹¼";
                        this.hp = this.maxHp = 30;
                        this.atk = 10;
                        this.weakness = null;
                        this.rewardExp = 12;
                        break;
                    case "slime":
                        this.name = "å²è±å§†";
                        this.hp = this.maxHp = 60;
                        this.atk = 5;
                        this.weakness = "fire";
                        this.rewardExp = 20;
                        break;
                }
            }
            
            takeDamage(damage) {
                this.hp = Math.max(0, this.hp - damage);
                return this.hp > 0;
            }
        }

        // å¤©æ°”ç³»ç»Ÿ
        class WeatherSystem {
            constructor() {
                this.weatherTypes = ["sunny", "rainy", "snowy"];
                this.currentWeather = this.getRandomWeather();
            }
            
            getRandomWeather() {
                return this.weatherTypes[Math.floor(Math.random() * this.weatherTypes.length)];
            }
            
            updateWeather() {
                this.currentWeather = this.getRandomWeather();
                return this.currentWeather;
            }
            
            getWeatherIcon() {
                switch(this.currentWeather) {
                    case "sunny": return "â˜€ï¸";
                    case "rainy": return "ğŸŒ§ï¸";
                    case "snowy": return "â„ï¸";
                }
            }
            
            getWeatherName() {
                switch(this.currentWeather) {
                    case "sunny": return "æ™´å¤©";
                    case "rainy": return "é›¨å¤©";
                    case "snowy": return "é›ªå¤©";
                }
            }
            
            getWeatherEffect() {
                switch(this.currentWeather) {
                    case "sunny": return "ç«å±æ€§å¢å¼º";
                    case "rainy": return "é›·å±æ€§å¢å¼ºï¼Œç«å±æ€§å‡å¼±";
                    case "snowy": return "å†°å±æ€§å¢å¼ºï¼Œæ•æ·é™ä½";
                }
            }
            
            getEffect(element) {
                switch(this.currentWeather) {
                    case "sunny": 
                        return element === "fire" ? 1.2 : 1.0;
                    case "rainy": 
                        if (element === "lightning") return 1.3;
                        if (element === "fire") return 0.8;
                        return 1.0;
                    case "snowy": 
                        return element === "ice" ? 1.5 : 1.0;
                    default:
                        return 1.0;
                }
            }
        }

        // é“å¾·ç³»ç»Ÿ
        class MoralSystem {
            constructor() {
                this.alignment = 0; // -100 (æ··æ²Œ) åˆ° +100 (ç§©åº)
            }
            
            applyChoice(choice) {
                let change = 0;
                switch(choice) {
                    case "save_villager": change = 20; break;
                    case "steal_treasure": change = -30; break;
                    case "spare_enemy": change = 15; break;
                    case "truth": change = 10; break;
                    case "lie": change = -10; break;
                    default: change = 0;
                }
                
                this.alignment = Math.max(-100, Math.min(100, this.alignment + change));
                return change;
            }
            
            getAlignmentName() {
                if (this.alignment >= 60) return "ç§©åºä¹‹å…‰";
                if (this.alignment <= -60) return "æ··æ²Œä¹‹æ¸Š";
                if (this.alignment >= 20) return "å®ˆåºå–„è‰¯";
                if (this.alignment <= -20) return "æ··ä¹±é‚ªæ¶";
                return "ç»å¯¹ä¸­ç«‹";
            }
            
            getEnding() {
                if (this.alignment >= 80) return "ç§©åºä¹‹å…‰ç»“å±€ï¼šä½ æˆä¸ºç‹å›½çš„å®ˆæŠ¤è€…";
                if (this.alignment <= -80) return "æ··æ²Œä¹‹æ¸Šç»“å±€ï¼šä½ ç»Ÿæ²»äº†é»‘æš—ä¸–ç•Œ";
                if (this.alignment >= 30) return "å’Œå¹³ç»“å±€ï¼šä¸–ç•Œæ¢å¤äº†å’Œå¹³";
                if (this.alignment <= -30) return "æ··ä¹±ç»“å±€ï¼šä¸–ç•Œé™·å…¥æ— æ”¿åºœçŠ¶æ€";
                return "ç°è‰²ç°å®ç»“å±€ï¼šä¸–ç•Œç»´æŒç€å¾®å¦™çš„å¹³è¡¡";
            }
        }

        // æ¸¸æˆå®ä¾‹
        const weatherSystem = new WeatherSystem();
        const moralSystem = new MoralSystem();

        // DOM æ“ä½œè¾…åŠ©å‡½æ•°
        function updatePlayerInfo() {
            if (!gameState.player) return;
            
            const player = gameState.player;
            document.getElementById("character-name").textContent = player.name;
            document.getElementById("character-status").textContent = player.getCharacterStatus();
            
            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById("hp-progress").style.width = `${(player.hp / player.maxHp) * 100}%`;
            document.getElementById("mp-progress").style.width = `${(player.mp / player.maxMp) * 100}%`;
            document.getElementById("xp-progress").style.width = `${Math.min(100, (player.experience / (player.level * 100)) * 100)}%`;
            
            // æ›´æ–°ç»Ÿè®¡å€¼
            document.getElementById("stat-strength").textContent = player.strength;
            document.getElementById("stat-agility").textContent = player.agility;
            document.getElementById("stat-intelligence").textContent = player.intelligence;
            document.getElementById("stat-level").textContent = player.level;
            document.getElementById("stat-xp").textContent = player.experience;
        }

        function updateWorldInfo() {
            document.getElementById("day-value").textContent = gameState.day;
            document.getElementById("location-value").textContent = gameState.location;
            document.getElementById("alignment-value").textContent = moralSystem.getAlignmentName();
            
            // æ›´æ–°å¤©æ°”ä¿¡æ¯
            document.getElementById("weather-icon").textContent = weatherSystem.getWeatherIcon();
            document.getElementById("weather-type").textContent = weatherSystem.getWeatherName();
            document.getElementById("weather-effect").textContent = weatherSystem.getWeatherEffect();
        }

        function addToConsole(message, className = "") {
            const consoleElement = document.getElementById("game-console");
            const messageElement = document.createElement("div");
            messageElement.className = `console-message ${className}`;
            messageElement.textContent = `>>> ${message}`;
            
            consoleElement.appendChild(messageElement);
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }

        function startNewDay() {
            gameState.day++;
            weatherSystem.updateWeather();
            
            addToConsole(`æ–°çš„ä¸€å¤©å¼€å§‹äº†ï¼ä»Šå¤©æ˜¯ç¬¬ ${gameState.day} å¤©ï¼Œå¤©æ°”: ${weatherSystem.getWeatherName()}`);
            addToConsole("æ¢ç´¢ä¸­...");
            
            setTimeout(generateEvent, 1500);
        }

        function generateEvent() {
            const events = [
                { type: "battle", weight: 60 },
                { type: "quest", weight: 20 },
                { type: "treasure", weight: 15 },
                { type: "moral_choice", weight: 5 }
            ];
            
            const totalWeight = events.reduce((sum, e) => sum + e.weight, 0);
            let randomValue = Math.floor(Math.random() * totalWeight);
            
            for (const event of events) {
                if (randomValue < event.weight) {
                    triggerEvent(event.type);
                    return;
                }
                randomValue -= event.weight;
            }
        }

        function triggerEvent(eventType) {
            const contentTitle = document.getElementById("content-title");
            
            switch(eventType) {
                case "battle":
                    contentTitle.textContent = "æˆ˜æ–—";
                    showBattleUI();
                    startBattle();
                    break;
                case "quest":
                    contentTitle.textContent = "ä»»åŠ¡";
                    showEventUI();
                    triggerQuestEvent();
                    break;
                case "treasure":
                    contentTitle.textContent = "å®è—";
                    showEventUI();
                    triggerTreasureEvent();
                    break;
                case "moral_choice":
                    contentTitle.textContent = "é“å¾·æŠ‰æ‹©";
                    showEventUI();
                    triggerMoralChoiceEvent();
                    break;
            }
        }

        function startBattle() {
            gameState.battleActive = true;
            gameState.enemies = [];
            
            const enemyTypes = ["goblin", "wolf", "slime"];
            const enemyCount = Math.floor(Math.random() * 2) + 1; // 1-2ä¸ªæ•Œäºº
            
            for (let i = 0; i < enemyCount; i++) {
                const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                gameState.enemies.push(new Enemy(type));
            }
            
            renderEnemies();
            
            addToConsole("ä½ é­é‡äº†æ•Œäººï¼š");
            gameState.enemies.forEach(enemy => {
                addToConsole(`  - ${enemy.name} [${enemy.hp}/${enemy.maxHp} HP]`);
            });
        }

        function renderEnemies() {
            const enemiesContainer = document.getElementById("battle-enemies");
            enemiesContainer.innerHTML = "";
            
            gameState.enemies.forEach((enemy, index) => {
                if (enemy.hp > 0) {
                    const enemyCard = document.createElement("div");
                    enemyCard.className = "enemy-card";
                    enemyCard.dataset.index = index;
                    
                    const nameElement = document.createElement("div");
                    nameElement.className = "enemy-name";
                    nameElement.textContent = enemy.name;
                    
                    const hpElement = document.createElement("div");
                    hpElement.textContent = `HP: ${enemy.hp}/${enemy.maxHp}`;
                    
                    enemyCard.appendChild(nameElement);
                    enemyCard.appendChild(hpElement);
                    enemiesContainer.appendChild(enemyCard);
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç”¨äºé€‰æ‹©ç›®æ ‡
                    enemyCard.addEventListener("click", function() {
                        document.querySelectorAll(".enemy-card").forEach(card => {
                            card.style.backgroundColor = "rgba(100, 30, 30, 0.7)";
                        });
                        enemyCard.style.backgroundColor = "rgba(150, 50, 50, 0.9)";
                        gameState.selectedEnemyIndex = index;
                    });
                }
            });
        }

        function playerAttack() {
            if (typeof gameState.selectedEnemyIndex === "undefined") {
                addToConsole("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ•Œäººç›®æ ‡ï¼");
                return;
            }
            
            const enemy = gameState.enemies[gameState.selectedEnemyIndex];
            if (!enemy || enemy.hp <= 0) {
                addToConsole("æ— æ•ˆçš„ç›®æ ‡ï¼è¯·é€‰æ‹©å…¶ä»–æ•Œäºº");
                return;
            }
            
            // è®¡ç®—ä¼¤å®³
            const damage = calculateDamage(gameState.player, enemy);
            const isAlive = enemy.takeDamage(damage);
            
            addToConsole(`${gameState.player.name} æ”»å‡»äº† ${enemy.name}ï¼Œé€ æˆäº† ${damage} ç‚¹ä¼¤å®³ï¼`, "battle-damage");
            
            if (!isAlive) {
                addToConsole(`${enemy.name} è¢«å‡»è´¥äº†ï¼`);
            }
            
            renderEnemies();
            updatePlayerInfo();
            
            // æ£€æŸ¥æˆ˜æ–—æ˜¯å¦ç»“æŸ
            setTimeout(checkBattleStatus, 1000);
        }

        function playerUseSkill() {
            if (typeof gameState.selectedEnemyIndex === "undefined") {
                addToConsole("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç›®æ ‡ï¼");
                return;
            }
            
            const enemy = gameState.enemies[gameState.selectedEnemyIndex];
            if (!enemy || enemy.hp <= 0) {
                addToConsole("æ— æ•ˆçš„ç›®æ ‡ï¼è¯·é€‰æ‹©å…¶ä»–æ•Œäºº");
                return;
            }
            
            const skillSelect = document.getElementById("skill-select");
            const selectedSkill = gameState.player.skills.find(s => s.id === skillSelect.value);
            
            // æ£€æŸ¥MP
            if (gameState.player.mp < selectedSkill.cost) {
                addToConsole(`MPä¸è¶³ï¼æ— æ³•ä½¿ç”¨ ${selectedSkill.name}`);
                return;
            }
            
            // æ¶ˆè€—MP
            gameState.player.mp -= selectedSkill.cost;
            updatePlayerInfo();
            
            if (selectedSkill.id === "heal") {
                // æ²»ç–—
                const healAmount = Math.floor(gameState.player.intelligence * 1.5 + 20);
                gameState.player.heal(healAmount);
                addToConsole(`${gameState.player.name} ä½¿ç”¨äº† æ²»ç–—æœ¯ï¼Œæ¢å¤äº† ${healAmount} ç‚¹ç”Ÿå‘½å€¼ï¼`, "battle-heal");
            } else {
                // æ”»å‡»æŠ€èƒ½
                const damage = calculateDamage(gameState.player, enemy, selectedSkill);
                const isAlive = enemy.takeDamage(damage);
                
                const elementIcon = selectedSkill.element === "fire" ? "ğŸ”¥" : "";
                addToConsole(`${gameState.player.name} ä½¿ç”¨äº† ${elementIcon}${selectedSkill.name}ï¼`, "element-fire");
                setTimeout(() => {
                    addToConsole(`å¯¹ ${enemy.name} é€ æˆäº† ${damage} ç‚¹ä¼¤å®³ï¼`, "battle-damage");
                    
                    if (!isAlive) {
                        addToConsole(`${enemy.name} è¢«å‡»è´¥äº†ï¼`);
                    }
                    
                    renderEnemies();
                    checkBattleStatus();
                }, 800);
            }
            
            // éšè—æŠ€èƒ½é€‰æ‹©ç•Œé¢
            document.getElementById("skill-select-section").style.display = "none";
            document.getElementById("battle-section").style.display = "block";
        }

        function calculateDamage(attacker, target, skill = null) {
            // åŸºç¡€ä¼¤å®³
            let baseDamage;
            if (skill) {
                baseDamage = skill.power;
                if (attacker.intelligence) {
                    baseDamage += attacker.intelligence * 0.5;
                }
            } else {
                baseDamage = attacker.strength * 2;
            }
            
            // å…ƒç´ å…‹åˆ¶
            let elementBonus = 1.0;
            if (skill && skill.element && target.weakness === skill.element) {
                elementBonus = 2.0;
                addToConsole(`${target.name} è¢« ${skill.element === "fire" ? "ğŸ”¥" : "â„ï¸"}å±æ€§å…‹åˆ¶ï¼ä¼¤å®³ç¿»å€ï¼`, "battle-critical");
            }
            
            // å¤©æ°”å½±å“
            let weatherBonus = skill ? weatherSystem.getEffect(skill.element) : 1.0;
            
            // æœ€ç»ˆä¼¤å®³
            let damage = Math.floor(baseDamage * elementBonus * weatherBonus);
            
            // æš´å‡»åˆ¤å®š
            const critChance = attacker.agility * 0.005;
            if (Math.random() < critChance) {
                damage = Math.floor(damage * 1.5);
                addToConsole("è‡´å‘½ä¸€å‡»ï¼", "battle-critical");
            }
            
            return Math.max(1, damage);
        }

        function enemyTurn() {
            if (!gameState.battleActive) return;
            
            gameState.enemies.forEach(enemy => {
                if (enemy.hp > 0) {
                    // éšæœºç©å®¶ç›®æ ‡
                    const player = gameState.player;
                    
                    // æ•Œäººè¡ŒåŠ¨
                    let damage = enemy.atk;
                    if (Math.random() < 0.3) { // 30%å‡ ç‡ç‰¹æ®Šæ”»å‡»
                        damage = Math.floor(enemy.atk * 1.5);
                        addToConsole(`${enemy.name} å‘åŠ¨äº†çŒ›å‡»ï¼`);
                    }
                    
                    const isAlive = player.takeDamage(damage);
                    addToConsole(`${enemy.name} æ”»å‡»äº† ${player.name}ï¼Œé€ æˆäº† ${damage} ç‚¹ä¼¤å®³ï¼`, "battle-damage");
                    updatePlayerInfo();
                    
                    if (!isAlive) {
                        gameOver();
                    }
                }
            });
        }

        function checkBattleStatus() {
            // æ£€æŸ¥æ‰€æœ‰æ•Œäººæ˜¯å¦è¢«å‡»è´¥
            const allDefeated = gameState.enemies.every(enemy => enemy.hp <= 0);
            
            if (allDefeated) {
                gameState.battleActive = false;
                // è®¡ç®—æ€»ç»éªŒ
                const totalExp = gameState.enemies.reduce((sum, enemy) => 
                    enemy.hp <= 0 ? sum + enemy.rewardExp : sum, 0);
                
                addToConsole(`æˆ˜æ–—èƒœåˆ©ï¼è·å¾— ${totalExp} ç»éªŒå€¼ï¼`, "battle-heal");
                const leveledUp = gameState.player.addExperience(totalExp);
                updatePlayerInfo();
                
                // éšè—æˆ˜æ–—UI
                setTimeout(() => {
                    document.getElementById("battle-section").style.display = "none";
                    startNewDay();
                }, 2000);
            } else {
                // æ•Œäººå›åˆ
                setTimeout(() => {
                    if (gameState.player.hp > 0) {
                        enemyTurn();
                    } else {
                        gameOver();
                    }
                }, 1000);
            }
        }

        function triggerQuestEvent() {
            const quests = [
                {
                    title: "æŠ¤é€å•†äºº",
                    description: "å°†å•†äººå®‰å…¨é€åˆ°é‚»é•‡",
                    moral: "order",
                    outcomes: ["æˆåŠŸ", "éƒ¨åˆ†æˆåŠŸ", "å¤±è´¥"]
                },
                {
                    title: "æ¸…é™¤ç›—è´¼",
                    description: "æ¶ˆç­æ£®æ—ä¸­çš„ç›—è´¼å›¢ä¼™",
                    moral: "chaos",
                    outcomes: ["æˆåŠŸ", "éƒ¨åˆ†æˆåŠŸ", "å¤±è´¥"]
                },
                {
                    title: "å¯»æ‰¾è‰è¯",
                    description: "ä¸ºæ‘é‡Œçš„åŒ»ç”Ÿå¯»æ‰¾æ²»ç–—è‰è¯",
                    moral: "neutral",
                    outcomes: ["æˆåŠŸ", "éƒ¨åˆ†æˆåŠŸ", "å¤±è´¥"]
                }
            ];
            
            const quest = quests[Math.floor(Math.random() * quests.length)];
            gameState.currentEvent = quest;
            
            const eventDesc = document.getElementById("event-description");
            eventDesc.innerHTML = `
                <div><strong>ä»»åŠ¡ï¼š</strong> ${quest.title}</div>
                <div>${quest.description}</div>
                <div><strong>ä»»åŠ¡è¿›è¡Œä¸­...</strong></div>
            `;
            
            // æ·»åŠ æŒ‰é’®
            const options = document.getElementById("event-options");
            options.innerHTML = "";
            
            // æ˜¾ç¤ºç»“æœæŒ‰é’®
            const resultBtn = document.createElement("div");
            resultBtn.className = "choice-btn";
            resultBtn.textContent = "æŸ¥çœ‹ä»»åŠ¡ç»“æœ";
            resultBtn.addEventListener("click", finishQuestEvent);
            options.appendChild(resultBtn);
        }

        function finishQuestEvent() {
            if (!gameState.currentEvent) return;
            
            const quest = gameState.currentEvent;
            const outcome = quest.outcomes[Math.floor(Math.random() * quest.outcomes.length)];
            
            const eventDesc = document.getElementById("event-description");
            eventDesc.innerHTML = `<div><strong>ä»»åŠ¡ç»“æœï¼š</strong>${outcome}ï¼</div>`;
            
            // æ ¹æ®ç»“æœæ·»åŠ å¥–åŠ±
            let rewardExp = 0;
            if (outcome === "æˆåŠŸ") {
                rewardExp = Math.floor(Math.random() * 31) + 20; // 20-50
                eventDesc.innerHTML += `<div>è·å¾— ${rewardExp} ç»éªŒå€¼</div>`;
            } else if (outcome === "éƒ¨åˆ†æˆåŠŸ") {
                rewardExp = Math.floor(Math.random() * 16) + 10; // 10-25
                eventDesc.innerHTML += `<div>è·å¾— ${rewardExp} ç»éªŒå€¼</div>`;
            }
            
            gameState.player.addExperience(rewardExp);
            updatePlayerInfo();
            
            if (outcome !== "å¤±è´¥") {
                const moralChange = moralSystem.applyChoice(quest.moral);
                eventDesc.innerHTML += `<div>é˜µè¥å˜åŒ–: ${moralChange > 0 ? '+' : ''}${moralChange}</div>`;
            }
            
            // æ›´æ–°ä¸–ç•Œä¿¡æ¯
            updateWorldInfo();
            
            // æ·»åŠ ç»§ç»­æŒ‰é’®
            const options = document.getElementById("event-options");
            options.innerHTML = "";
            
            const continueBtn = document.createElement("div");
            continueBtn.className = "choice-btn";
            continueBtn.textContent = "ç»§ç»­æ—…ç¨‹";
            continueBtn.addEventListener("click", function() {
                document.getElementById("event-section").style.display = "none";
                startNewDay();
            });
            options.appendChild(continueBtn);
        }

        function triggerTreasureEvent() {
            const treasures = [
                {
                    name: "å®ç®±",
                    description: "ä½ å‘ç°äº†ä¸€ä¸ªå¤è€çš„å®ç®±ï¼",
                    reward: { experience: Math.floor(Math.random() * 21) + 30 } // 30-50
                },
                {
                    name: "è‰è¯è¢‹",
                    description: "ä½ é‡‡é›†äº†ä¸€äº›ç¨€æœ‰è‰è¯",
                    reward: { experience: Math.floor(Math.random() * 16) + 10 } // 10-25
                },
                {
                    name: "é­”æ³•æ°´æ™¶",
                    description: "ä¸€å—å‘å…‰çš„é­”æ³•æ°´æ™¶",
                    reward: { hp: Math.floor(Math.random() * 21) + 20 } // 20-40
                }
            ];
            
            const treasure = treasures[Math.floor(Math.random() * treasures.length)];
            gameState.currentEvent = treasure;
            
            const eventDesc = document.getElementById("event-description");
            eventDesc.innerHTML = `
                <div>${treasure.description}</div>
                <div><strong>ä½ å‘ç°äº†ä¸€ä¸ªå®ç‰©ï¼š</strong> ${treasure.name}</div>
            `;
            
            // æ·»åŠ æŒ‰é’®
            const options = document.getElementById("event-options");
            options.innerHTML = "";
            
            const openBtn = document.createElement("div");
            openBtn.className = "choice-btn";
            openBtn.textContent = "æ‰“å¼€" + (treasure.name === "å®ç®±" ? "å®ç®±" : treasure.name);
            openBtn.addEventListener("click", function() {
                // åº”ç”¨å¥–åŠ±
                let rewardMessage = "";
                if (treasure.reward.experience) {
                    gameState.player.addExperience(treasure.reward.experience);
                    rewardMessage = `è·å¾— ${treasure.reward.experience} ç»éªŒå€¼ï¼`;
                    updatePlayerInfo();
                } else if (treasure.reward.hp) {
                    gameState.player.heal(treasure.reward.hp);
                    rewardMessage = `æ¢å¤ ${treasure.reward.hp} ç‚¹ç”Ÿå‘½å€¼ï¼`;
                    updatePlayerInfo();
                }
                
                eventDesc.innerHTML += `<div class="battle-heal">${rewardMessage}</div>`;
                openBtn.style.display = "none";
                
                // æ·»åŠ ç»§ç»­æŒ‰é’®
                const continueBtn = document.createElement("div");
                continueBtn.className = "choice-btn";
                continueBtn.textContent = "ç»§ç»­æ—…ç¨‹";
                continueBtn.addEventListener("click", function() {
                    document.getElementById("event-section").style.display = "none";
                    startNewDay();
                });
                options.appendChild(continueBtn);
            });
            
            options.appendChild(openBtn);
        }

        function triggerMoralChoiceEvent() {
            const choices = [
                {
                    situation: "ä½ å‘ç°å—ä¼¤çš„æ—…è¡Œè€…",
                    options: {
                        save: {
                            text: "æ•‘åŠ©ä»–",
                            result: {
                                message: "æ—…è¡Œè€…æ„Ÿè°¢ä½ å¹¶èµ äºˆä½ é‡‘å¸",
                                reward: { experience: Math.floor(Math.random() * 21) + 20 } // 20-40
                            },
                            moral: "save_villager"
                        },
                        steal: {
                            text: "æŠ¢åŠ«ä»–",
                            result: {
                                message: "ä½ å·èµ°äº†æ—…è¡Œè€…çš„è´¢ç‰©",
                                reward: { experience: Math.floor(Math.random() * 11) + 10 } // 10-20
                            },
                            moral: "steal_treasure"
                        }
                    }
                },
                {
                    situation: "å«å…µè¦æ±‚æœæŸ¥ä½ çš„èƒŒåŒ…",
                    options: {
                        cooperate: {
                            text: "é…åˆæœæŸ¥",
                            result: {
                                message: "å«å…µæ„Ÿè°¢ä½ çš„åˆä½œ",
                                reward: { experience: Math.floor(Math.random() * 11) + 5 } // 5-15
                            },
                            moral: "truth"
                        },
                        bribe: {
                            text: "æ‹’ç»å¹¶è´¿èµ‚",
                            result: {
                                message: "ä½ è´¿èµ‚äº†å«å…µé¿å…äº†æœæŸ¥",
                                reward: { experience: Math.floor(Math.random() * 6) + 5 } // 5-10
                            },
                            moral: "lie"
                        }
                    }
                }
            ];
            
            const choiceEvent = choices[Math.floor(Math.random() * choices.length)];
            gameState.currentEvent = choiceEvent;
            
            const eventDesc = document.getElementById("event-description");
            eventDesc.innerHTML = `<div><strong>é“å¾·æŠ‰æ‹©ï¼š</strong> ${choiceEvent.situation}</div>`;
            
            // æ·»åŠ é€‰é¡¹æŒ‰é’®
            const options = document.getElementById("event-options");
            options.innerHTML = "";
            
            for (const key in choiceEvent.options) {
                const option = choiceEvent.options[key];
                const choiceBtn = document.createElement("div");
                choiceBtn.className = "choice-btn";
                choiceBtn.textContent = option.text;
                choiceBtn.dataset.choice = key;
                choiceBtn.addEventListener("click", function() {
                    const choiceKey = this.dataset.choice;
                    const option = choiceEvent.options[choiceKey];
                    
                    // åº”ç”¨å¥–åŠ±
                    if (option.reward.experience) {
                        gameState.player.addExperience(option.reward.experience);
                        updatePlayerInfo();
                    }
                    
                    // åº”ç”¨é“å¾·å˜åŒ–
                    const moralChange = moralSystem.applyChoice(option.moral);
                    
                    // æ›´æ–°æ˜¾ç¤º
                    eventDesc.innerHTML += `
                        <div>${option.result.message}</div>
                        <div class="battle-heal">è·å¾— ${option.reward.experience} ç»éªŒå€¼</div>
                        <div>é˜µè¥å˜åŒ–: ${moralChange > 0 ? '+' : ''}${moralChange}</div>
                    `;
                    
                    // æ›´æ–°ä¸–ç•Œä¿¡æ¯
                    updateWorldInfo();
                    
                    // æ¸…é™¤é€‰é¡¹æŒ‰é’®
                    options.innerHTML = "";
                    
                    // æ·»åŠ ç»§ç»­æŒ‰é’®
                    const continueBtn = document.createElement("div");
                    continueBtn.className = "choice-btn";
                    continueBtn.textContent = "ç»§ç»­æ—…ç¨‹";
                    continueBtn.addEventListener("click", function() {
                        document.getElementById("event-section").style.display = "none";
                        startNewDay();
                    });
                    options.appendChild(continueBtn);
                });
                
                options.appendChild(choiceBtn);
            }
        }

        function gameOver() {
            addToConsole("ä½ çš„è§’è‰²åœ¨æˆ˜æ–—ä¸­å€’ä¸‹...æ¸¸æˆç»“æŸ");
            
            // ç»“æŸæ¸¸æˆé€»è¾‘
            document.getElementById("battle-section").style.display = "none";
            
            setTimeout(() => {
                addToConsole("===== æ¸¸æˆç»“æŸ =====");
                addToConsole(`æœ€ç»ˆç­‰çº§: ${gameState.player.level}`);
                addToConsole(`é˜µè¥: ${moralSystem.getAlignmentName()}`);
                addToConsole(moralSystem.getEnding());
                
                const gameEnd = document.getElementById("action-container");
                gameEnd.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <h2>æ¸¸æˆç»“æŸ</h2>
                        <p>æœ€ç»ˆç­‰çº§: ${gameState.player.level} | é˜µè¥: ${moralSystem.getAlignmentName()}</p>
                        <p>${moralSystem.getEnding()}</p>
                        <button id="restart-btn" class="btn btn-action" style="margin-top: 20px;">é‡æ–°å¼€å§‹</button>
                    </div>
                `;
                
                document.getElementById("restart-btn").addEventListener("click", function() {
                    location.reload();
                });
            }, 2000);
        }

        // UIæ§åˆ¶å‡½æ•°
        function showBattleUI() {
            document.getElementById("name-input-section").style.display = "none";
            document.getElementById("event-section").style.display = "none";
            document.getElementById("battle-section").style.display = "block";
            document.getElementById("skill-select-section").style.display = "none";
        }

        function showEventUI() {
            document.getElementById("name-input-section").style.display = "none";
            document.getElementById("battle-section").style.display = "none";
            document.getElementById("skill-select-section").style.display = "none";
            document.getElementById("event-section").style.display = "block";
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById("start-btn").addEventListener("click", function() {
            const nameInput = document.getElementById("character-name-input");
            const playerName = nameInput.value.trim() || "å†’é™©è€…";
            
            gameState.player = new Character(playerName);
            gameState.gameStarted = true;
            
            updatePlayerInfo();
            updateWorldInfo();
            
            addToConsole(`${playerName} å¼€å§‹äº†åœ¨è‰¾ç‘Ÿå…°å¤§é™†çš„å†’é™©ï¼`);
            
            document.getElementById("name-input-section").style.display = "none";
            startNewDay();
        });

        // æŠ€èƒ½é€‰æ‹©
        document.querySelector(".btn-skill").addEventListener("click", function() {
            document.getElementById("battle-section").style.display = "none";
            document.getElementById("skill-select-section").style.display = "flex";
        });

        document.getElementById("use-skill-btn").addEventListener("click", playerUseSkill);

        // æ”»å‡»
        document.querySelector(".btn-attack").addEventListener("click", playerAttack);

        // é€ƒè·‘
        document.querySelector(".btn-flee").addEventListener("click", function() {
            const fleeChance = gameState.player.agility * 0.1;
            if (Math.random() < fleeChance) {
                addToConsole("æˆåŠŸé€ƒç¦»äº†æˆ˜æ–—ï¼");
                gameState.battleActive = false;
                document.getElementById("battle-section").style.display = "none";
                startNewDay();
            } else {
                addToConsole("é€ƒè·‘å¤±è´¥ï¼");
                setTimeout(enemyTurn, 800);
            }
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        updateWorldInfo();
    </script>
</body>
</html>